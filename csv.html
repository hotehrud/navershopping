<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Table to TSV</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <style>
        table, th, tr, td {
            border: 1px solid black;
        }
    </style>
</head>
<body>
<div>
    <a href="" id="a"><button id="download">다운로드</button></a>
    <button id="addRow">추가</button>
    <button id="tsvWrite" type="submit">저장</button>
    <button id="removeRow">삭제</button>
</div>

<div id="table"></div>

<script>
    $(function() {
        'use strict';

        var mygumi = {},
            variable = {};

        mygumi.init = function() {
            mygumi.event.autoEventFnc();

            mygumi.start();
        }

        mygumi.start = function() {
            var manualExecFnc = ['downloadTsvFile', 'saveTsvFile'];

            mygumi.async.readTsvFile(function(res) {

                mygumi.dom.createInitTable(res);

                mygumi.event.manualEventFnc(manualExecFnc);
            });

        }

        mygumi.event = (function() {
            var event = {};

            event.autoEvent = {
                addRowEvent : function() {

                    $('#addRow').on('click', function() {
                        console.log("추가");
                        var uid = prompt('추가하실 행의 id 컬럼의 값을 입력하세요', '');

                        if (uid) {
                            var tr = document.createElement('tr');
                            tr.setAttribute('id', uid);

                            tr.appendChild(mygumi.dom.addRow(uid, true));

                            for(var i=1;i<variable['colNumber'];i++) {

                                tr.appendChild(mygumi.dom.addRow(''));

                            }

                            $('#table > table').append(tr);
                            console.log("addRow");
                        }

                    });
                },

                deleteRow : function() {

                    $('#removeRow').on('click', function() {
                        console.log('remove');
                        var uid = prompt('삭제하실 id 컬럼의 값을 입력하세요', '');
                        var uidRow = $('#' + uid);

                        if (uid) {
                            if (uidRow.attr('id') !== undefined) {
                                uidRow.remove();
                            } else {
                                alert("id 컬럼의 값을 잘못 입력하셨습니다.");
                            }
                        }

                    });

                },

                changeId : function() {

                    $("#table").on('keydown, mouseout', '#tsv tr td' ,function() {
                        var focusElement = $(this).find('.uid');

                        if (focusElement.attr('class') == 'uid') {
                            focusElement.parent().parent().attr('id', focusElement.val());
                        }

                    })
                }
            }

            event.manualEvent = {
                downloadTsvFile : function() {

                    $('#download').on('click', function() {
                        console.log("download");

                        var tsvString = tsvArrayConevert();

                        tsvFileConvert(tsvString);
                    });

                },

                saveTsvFile : function() {

                    $('#tsvWrite').on('click', function() {
                        console.log("save");

                        var tsvString = tsvArrayConevert();

                        mygumi.async.writeTsvFile(tsvString);
                    });
                }

            }

            event.autoEventFnc = function() {
                var autoEventObj = event.autoEvent;

                for (var property in autoEventObj) {
                    if (autoEventObj.hasOwnProperty(property)) {
                        autoEventObj[property].call();
                    }
                }

            };

            event.manualEventFnc = function(array) {
                var manualEventObj = event.manualEvent;

                for (var i in array) {
                    manualEventObj[array[i]].call();
                }

            };

            function tsvArrayConevert() {
                var tsvArray = new Array();
                var oTable = document.getElementById('tsv');

                //gets rows of table
                var rowLength = oTable.rows.length;

                //loops through rows
                for (var i = 0; i < rowLength; i++) {
                    tsvArray[i] = new Array();

                    //gets cells of current row
                    var oCells = oTable.rows.item(i).cells;

                    //gets amount of cells of current row
                    var cellLength = oCells.length;

                    //loops through each cell in current row
                    for(var j = 0; j < cellLength; j++) {
                        /* get your cell info here */
                        var cellVal = oCells.item(j).getElementsByTagName("input")[0].value;
                        tsvArray[i][j] = cellVal;
                    }
                }

                return tsvStringConvert(tsvArray);

            }

            function tsvStringConvert(array) {
                var arrayLen = array.length;
                var tsvText = "";

                for(var i=0;i<arrayLen;i++) {

                    var row = array[i];

                    for(var index in row) {

                        tsvText += row[index] + '\t';

                    }
                    tsvText += '\n';

                }

                return tsvText;

            }

            function tsvFileConvert(tsvText) {
                var a = document.getElementById("a");
                var tsvFile = new Blob([tsvText], {type: 'text/plain'});
                a.href = URL.createObjectURL(tsvFile);
                a.download = 'navershopping.txt';
            }

            return event;
        }());

        mygumi.async = (function() {
            var async = {};

            async.readTsvFile = function(callback) {
                $.ajax({
                    type: "GET",
                    url: "navershopping.txt",
                    dataType: "text",
                    success: function(str) {
                        var item = str.split('\n');

                        for (var i=0; i<item.length; i++) {
                            var columnValue = item[i].split('\t');
                            item[i] = columnValue;
                        }

                        variable['colNumber'] = item[0].length;


                        if (typeof(callback) == 'function') {
                            callback(item);
                        }

                    }
                });
            }

            async.writeTsvFile = function(str) {
                $.ajax({
                    type: "POST",
                    url: "test.php",
                    data: {tsv:str},
                    success: function(data) {
                        console.log(data);
                    }
                });
            }

            return async;
        }());

        mygumi.dom = (function() {
            var dom = {};

            dom.createInitTable = function(tsv) {
                var array = tsv;
                var arrayLength = array.length;
                var theTable = document.createElement('table');
                theTable.setAttribute('id', 'tsv');

                for (var i=0;i<arrayLength;i++) {

                    if (array[i][0] == '') {
                        break;
                    }

                    var tr = document.createElement('tr');
                    tr.setAttribute('id', array[i][0]);

                    $.each(array[i], function(index, value) {

                        tr.appendChild(dom.addRow(value, index == 0));
                    });

                    theTable.appendChild(tr);
                }

                document.getElementById('table').appendChild(theTable);
            }

            dom.addRow = function(value, add) {
                // param - value, (class="uid")

                var td = document.createElement('td');
                var input = document.createElement("input");
                input.setAttribute("type", "text");
                input.setAttribute("value", value);

                if (value != '' && add) {
                    input.setAttribute('class', 'uid');
                }

                td.appendChild(input);

                return td;
            }

            return dom;
        }());

        mygumi.init();

    })
</script>
</body>
</html>