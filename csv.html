<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Table to TSV</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <style>
        table, th, tr, td {
            border: 1px solid black;
        }

        #table {
            position: absolute;
            top:100px;
        }

        #table tr td input {
            background-color: #8C8C8C;
            color: white;
        }

        .essential {
            color:red !important;
        }

        #headButton {
            position: fixed;
            left: 50px;
            background: #1f1f1f;
            padding: 20px;
            color: #fff;
            border: 1px solid #444;
            border-left: 1px solid #444;
            border-right: 1px solid #111;
            border-bottom: 1px solid #111;
            box-sizing: border-box;
            z-index: 99999;
        }

        body {
            background: #2a2a2a none repeat scroll 0 0;
            font-family: Gill Sans, sans-serif;
        }



    </style>
</head>
<body>

<div>
    <div id="headButton">
        NaverShopping EP 3.0
        <a href="" id="a"><button id="download">다운로드</button></a>
        <button id="addRow">추가</button>
        <button id="tsvWrite" type="submit">저장</button>
        <button id="removeRow">삭제</button>
    </div>

</div>

<div id="table"></div>

<script>
    $(function() {
        'use strict';

        var mygumi = {},
                variable = {};

        mygumi.init = function() {
            var essential = {id:1, title:2, price_pc:3, link:6, image_link:8, category_name1:10, shipping:42};
            var esIndexArray = [];

            for (var property in essential) {
                esIndexArray.push(essential[property]);
            }

            variable['esIndexArray'] = esIndexArray;
            variable['essential'] = essential;
            variable['uidArray'] = [];

            mygumi.event.autoEventFnc();

            mygumi.start();
        }

        mygumi.start = function() {
            var manualExecFnc = ['downloadTsvFile', 'saveTsvFile'];

            mygumi.async.readTsvFile(function(res) {

                mygumi.dom.createInitTable(res);

                mygumi.dom.firstRowSetting();

                mygumi.event.manualEventFnc(manualExecFnc);
            });

        }

        mygumi.event = (function() {
            var event = {};

            event.autoEvent = {
                addRowEvent : function() {

                    $('#addRow').on('click', function() {
                        console.log("추가");
                        var uid = prompt('추가하실 행의 id 컬럼의 값을 입력하세요', '');

                        if (uid) {
                            var tr = document.createElement('tr');
                            tr.setAttribute('id', uid);

                            tr.appendChild(mygumi.dom.addRow(uid, true));

                            for (var i=1;i<variable['colNumber'];i++) {

                                tr.appendChild(mygumi.dom.addRow(''));

                            }

                            $('#table > table').append(tr);
                            console.log("addRow");
                        }

                    });
                },

                deleteRow : function() {

                    $('#removeRow').on('click', function() {
                        console.log('remove');
                        var uid = prompt('삭제하실 id 컬럼의 값을 입력하세요', '');
                        var uidRow = $('#' + uid);

                        if (uid) {
                            if (uidRow.attr('id') !== undefined) {

                                variable['uidArray'].splice($.inArray(uid, variable['uidArray']), 1);

                                uidRow.remove();
                            } else {
                                alert("id 컬럼의 값을 잘못 입력하셨습니다.");
                            }
                        }

                    });

                },

                changeId : function() {

                    $("#table").on('keydown, focusout', '#tsv tr td' ,function() {
                        var focusElement = $(this).find('.uid');

                        if (focusElement.attr('class') == 'uid') {
                            focusElement.parent().parent().attr('id', focusElement.val());
                        }

                    })
                }
            }

            event.manualEvent = {
                downloadTsvFile : function() {

                    $('#download').on('click', function() {
                        console.log("download");

                        var tsvString = tsvArrayConvert();

                        if (typeof tsvString == 'undefined') {
                            alert("오류 발생. 오류 지점으로 자동으로 포커스가 이동됩니다.")
                            return false;
                        } else {
                            console.log('download success');
                            tsvFileConvert(tsvString);
                        }

                    });

                },

                saveTsvFile : function() {

                    $('#tsvWrite').on('click', function() {
                        console.log("save");

                        var tsvString = tsvArrayConvert();

                        if (typeof tsvString == 'undefined') {
                            alert("오류 발생. 오류 지점으로 자동으로 포커스가 이동됩니다.")
                            return false;
                        } else {
                            console.log('write success');
                            mygumi.async.writeTsvFile(tsvString);
                        }

                    });
                }

            }

            event.autoEventFnc = function() {
                var autoEventObj = event.autoEvent;

                for (var property in autoEventObj) {
                    if (autoEventObj.hasOwnProperty(property)) {
                        autoEventObj[property].call();
                    }
                }

            };

            event.manualEventFnc = function(array) {
                var manualEventObj = event.manualEvent;

                for (var i in array) {
                    manualEventObj[array[i]].call();
                }

            };

            function tsvArrayConvert() {
                var tsvArray = new Array();
                var oTable = document.getElementById('tsv');

                //gets rows of table
                var rowLength = oTable.rows.length;

                //loops through rows
                for (var i = 0; i < rowLength; i++) {
                    tsvArray[i] = new Array();

                    //gets cells of current row
                    var oCells = oTable.rows.item(i).cells;

                    //gets amount of cells of current row
                    var cellLength = oCells.length;

                    //loops through each cell in current row
                    for (var j = 0; j < cellLength; j++) {
                        /* get your cell info here */
                        var cellVal = oCells.item(j).getElementsByTagName("input")[0].value;

                        tsvArray[i][j] = cellVal;
                    }
                }

                return tsvStringConvert(tsvArray);

            }

            function tsvStringConvert(array) {
                var arrayLen = array.length;
                var tsvText = "";

                for (var i=0;i<arrayLen;i++) {

                    var row = array[i];
                    var rowText = "";

                    for (var index in row) {

                        rowText += row[index] + '\t';

                    }

                    var lastIndex = rowText.lastIndexOf('\t');
                    rowText = rowText.substring(0, lastIndex);

                    if (!mygumi.valid.essentialCheck(rowText, i)) {
                        console.log('fail');
                        return;
                    }

                    tsvText += rowText + '\n';

                }

                lastIndex = tsvText.lastIndexOf('\n');
                tsvText = tsvText.substring(0, lastIndex);

                return tsvText;

            }

            function tsvFileConvert(tsvText) {
                var a = document.getElementById("a");
                var tsvFile = new Blob([tsvText], {type: 'text/plain'});
                a.href = URL.createObjectURL(tsvFile);
                a.download = 'navershopping.txt';
            }

            return event;
        }());

        mygumi.async = (function() {
            var async = {};

            async.readTsvFile = function(callback) {
                $.ajax({
                    type: "GET",
                    url: "naver/naver.txt",
                    dataType: "text",
                    success: function(str) {
                        var item = str.split('\n');

                        for (var i=0; i<item.length; i++) {
                            var columnValue = item[i].split('\t');
                            item[i] = columnValue;
                        }

                        variable['colNumber'] = item[0].length;


                        if (typeof(callback) == 'function') {
                            callback(item);
                        }

                    }
                });
            }

            async.writeTsvFile = function(str) {
                $.ajax({
                    type: "POST",
                    url: "test.php",
                    dataType: "text",
                    data: "dataString=" + str,
                    success: function(data) {
                        console.log(data);
                    },
                    error:function(request,status,error){
                        console.log("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
                    }
                });
            }

            return async;
        }());

        mygumi.valid = (function() {
            var valid = {};

            valid.essentialCheck = function(str, row) {
                // console.log('essentialCheck');
                var esIndexArray = variable['esIndexArray'];

                var item = str.split('\t');
                var itemLength = item.length;

                for (var i=0;i<itemLength;i++) {
                    if (item[i] == '' && esIndexArray.indexOf(i+1) > -1) {
                        console.log('공백 행 : ' + (row+1) + '공백 열 : ' + (i+1));

                        moveFocus(row, i, '#tsv tr', 'td input');

                        return false;
                    }
                }

                return true;
            }

            function moveFocus(row, col, rowTag, colTag) {
                var row = $(rowTag)[row];

                $(row).find(colTag)[col].focus();
            }

            return valid;
        }());

        mygumi.dom = (function() {
            var dom = {};

            dom.createInitTable = function(tsv) {
                var array = tsv;
                var arrayLength = array.length;
                var theTable = document.createElement('table');
                theTable.setAttribute('id', 'tsv');

                for (var i=0;i<arrayLength;i++) {

                    var tr = document.createElement('tr');
                    tr.setAttribute('id', array[i][0]);

                    $.each(array[i], function(index, value) {

                        variable['uidArray'].push(value);
                        tr.appendChild(dom.addRow(value, index == 0));
                    });

                    theTable.appendChild(tr);
                }

                document.getElementById('table').appendChild(theTable);
            }

            dom.addRow = function(value, add) {
                // param - value, (class="uid")

                var td = document.createElement('td');
                var input = document.createElement("input");
                input.setAttribute("type", "text");
                input.setAttribute("value", value);

                if (value != '' && add) {
                    input.setAttribute('class', 'uid');
                    variable['uidArray'].push(value);
                }

                td.appendChild(input);

                return td;
            }

            dom.firstRowSetting = function() {
                var es = variable['essential'];

                var firstRow =  $('#id td input');

                $.each(firstRow, function(index, value) {

                    if (es.hasOwnProperty($(this).val())) {
                        $(this).addClass('essential');
                    }

                });

            }

            return dom;
        }());

        function addEventListener(event, fn) {
            if (window.addEventListener) {
                return window.addEventListener(event, fn);
            }

            return window.attachEvent('on' + event, fn);
        }

        mygumi.init();

    })
</script>
</body>
</html>